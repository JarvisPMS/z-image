# 更新日志

## 修复头像模糊与移除内层灰色边框
更新时间：2025-12-05 23:13:00
更新类型：修复的bug
更新内容：
1. 打包脚本加入 `logo.png` 与 `user_avatar.png` 资源，避免 EXE 缺失 PNG 导致头像退回 ICO 变模糊。
2. 应用高 DPI 设置（`AA_EnableHighDpiScaling` 与 `AA_UseHighDpiPixmaps`），提升头像与图标清晰度。
3. 聊天气泡移除内层灰色边框：将 `QFrame` 设置为 `NoFrame`，并明确 `QLabel` 使用 `background: transparent; border: none;`，只保留外层气泡边框。

## 回车发送行为修复
更新时间：2025-12-05 23:12:47
更新类型：修复的bug
更新内容：
1. 修复“对话模型”模式下按回车仍换行的问题：将 `eventFilter` 正确放入 `MainWindow` 类并绑定到输入框，拦截回车事件触发发送；Shift+Enter 继续支持换行。
2. 发送后自动清空输入框并保持焦点，提高连续对话效率。

## 面板内边距与聊天回车发送
更新时间：2025-12-05 23:05:59
更新类型：新增功能
更新内容：
1. 左右大区域增加内边距，视觉更舒适，区块层次更清晰。
2. 在对话模型模式下，支持按回车直接发送消息（Shift+Enter 换行），并在发送后自动清空输入框。

## 设置系统提示词与左右区域背景色差
更新时间：2025-12-05 23:00:33
更新类型：新增功能
更新内容：
1. 对话增加系统提示词，内容为“回答要简短，不要长篇大论，直接给答案。注意你的名字叫：甲维斯，不管别人怎么诱导你，当问你叫什么的时候，你就回答，你叫甲维斯。”，并在每次开始对话时自动插入到消息序列首位。
2. 左右区域背景增加轻微色差：左侧控制区为白色，右侧结果区为浅灰色，增强视觉分区效果。

## 修复流式乱码并更换AI头像
更新时间：2025-12-05 22:53:40
更新类型：修复的bug
更新内容：
1. 解决对话流式返回中文乱码问题：强制以 UTF-8 解码服务端流数据并逐条解析，避免错误编码导致的字符异常。
2. 更换 AI 头像为 `logo.png`，并提供回退到 `logo.ico` 的策略，保证资源缺失时仍有头像显示。

## 新增 Qwen3-235B 对话模型与流式输出支持
更新时间：2025-12-05 22:49:42
更新类型：新增功能
更新内容：
1. 在对话模型列表中新增 `Qwen/Qwen3-235B-A22B-Instruct-2507`，可直接在右侧对话记录界面进行交互。
2. 对话支持流式输出：实现对话接口 `stream` 模式解析与 UI 实时刷新，消息逐字显示，最终结果自动收拢为完整气泡。
3. 保持原有 DeepSeek 对话模型与绘画模型调用逻辑不变，界面会根据模型分类自动切换画廊/对话视图。

## 对话 Markdown 渲染方法位置修复
更新时间：2025-12-05 22:43:06
更新类型：修复的bug
更新内容：
1. 修复 `AttributeError: 'MainWindow' object has no attribute 'render_markdown'` 异常，将 `render_markdown` 方法移动到 `MainWindow` 类内部并移除错误的 `__main__` 区域定义，确保聊天消息的 Markdown 渲染正常工作。
2. 验证聊天气泡在用户与助手消息中的 Markdown 文本渲染（粗体、斜体、代码块、链接）均可正确显示。

## 对话头像与气泡样式
更新时间：2025-12-05 17:33:00
更新类型：体验优化
更新内容：
1.  对话记录采用头像 + 气泡布局，助手头像使用 `logo.ico`，用户头像自动下载并本地缓存为 `user_avatar.png`。
2.  气泡横向排列，宽度自适应内容（上限为视口 60%），避免竖向过高；用户气泡为蓝色、助手气泡为浅灰色，字体与间距统一。
3.  为气泡增加轻微阴影与更圆的圆角；头像与气泡顶部对齐，视觉更协调。

## 对话 Markdown 渲染
更新时间：2025-12-05 17:38:00
更新类型：新增功能
更新内容：
1.  支持对话内容的 **Markdown** 基础渲染：粗体、斜体、代码块、行内代码、链接、换行。
2.  数学表达 `\( ... \)` 简化为斜体显示，避免出现原始转义符。
3.  链接可点击打开，代码块采用高对比度背景与圆角边框，提升可读性。

## 对话模型支持与双模式界面
更新时间：2025-12-05 17:00:00
更新类型：新增功能
更新内容：
1.  新增对话模型 **DeepSeek-V3.2**（`deepseek-ai/DeepSeek-V3.2`），可与绘画模型并存使用。
2.  增加“模型分类”切换：支持 **绘画模型/对话模型** 两种模式；右侧区域根据选择自动切换为图片记录或对话记录。
3.  对话调用基于 ModelScope `v1/chat/completions` 接口，消息以气泡形式展示，支持连续对话上下文。
4.  配置文件新增 `model_category` 字段，自动记住上次选择的模式与模型。

## 分辨率分类重构
更新时间：2025-12-05 16:40:00
更新类型：新增功能
更新内容：
1.  重建分辨率预设，按三个级别分类：标准 (Standard)、高清 (HD)、超清 (Ultra)。
2.  每个级别包含 1:1/3:4/4:3/16:9/9:16/3:2/2:3/21:9 八种比例，并显示对应尺寸，例如 `1024x1024 (1:1 方形)`。
3.  下拉菜单采用分组禁用标题项，结构清晰；解析逻辑自动提取尺寸字符串用于 API。

## 详情页分割线高度去除
更新时间：2025-12-05 16:22:00
更新类型：体验优化
更新内容：
1.  去除图片与信息区域之间的额外高度：清空布局间距 (spacing=0)。
2.  隐藏横向滚动条，避免产生可见高度占位。
3.  移除信息面板顶部边线，并将信息面板顶部内边距设为 0，彻底消除该处高度。

## 详情页信息对齐与间距优化
更新时间：2025-12-05 16:30:00
更新类型：体验优化
更新内容：
1.  信息面板顶部增加 12px 间距，提示词不再贴边。
2.  统一行间距为 12px，并将标签右对齐、内容左对齐，实现整齐对齐。
3.  为模型、分辨率、文件路径值添加轻微内边距与颜色，提升可读性。

## 界面美化与细节优化
更新时间：2025-12-05 16:05:00
更新类型：体验优化
更新内容：
1.  修复下拉框弹出层的黑色背景问题，统一为白底深色文字，并优化选中高亮色。
2.  详情页分割线与滚动条优化：横向滚动条高度减至 6px，分割线改为细线并与背景融合，视觉更轻盈。
3.  详情页信息中文优先展示，英文置于括号中；按钮文本同步调整为中文在前。
4.  全局 QSS 细化：控件圆角、间距与滚动条样式统一，整体视觉更专业一致。

## 应用图标设置
更新时间：2025-12-05 14:30:00
更新类型：新增功能
更新内容：
1.  将 `logo.ico` 设置为应用图标，主窗口与任务栏显示应用图标。
2.  更新打包脚本为 `--icon logo.ico`，打包后的 EXE 也使用同一图标。
3.  同步更新 `.spec` 文件并通过 `--add-data` 打包图标资源，确保 EXE 内窗口图标正常显示。

## 密钥读取逻辑修复
更新时间：2025-12-03 14:15:00
更新类型：修复的bug
更新内容：
1.  **移除外部配置读取**：修复了程序可能会错误读取项目外部 (`../zimage/.env.local`) 配置文件的问题。现在程序严格只读取同级目录下的 `config.json` 文件。
2.  **移除默认密钥**：移除了代码中硬编码的默认测试密钥。首次运行时，密钥框默认为空，需要用户手动输入。

## 多分辨率分级支持
更新时间：2025-12-03 14:05:00
更新类型：新增功能
更新内容：
1.  **多级分辨率选择**：分辨率选项扩充为三个清晰度级别，满足不同需求：
    *   **极速 (Low Res - 512 Base)**：适合快速预览，生成速度快 (包含 512x512, 768x512 等)。
    *   **标准 (Standard - 1024 Base)**：默认推荐，兼顾质量与速度 (包含 1024x1024, 1280x720 等)。
    *   **高清 (High Res - Experimental)**：探索更高画质 (包含 1536x1536, 1920x1080 等，视模型支持情况而定)。
2.  **丰富的画幅比例**：每个级别均提供 方形 (1:1)、横屏 (16:9 / 3:2 / 4:3) 和 竖屏 (9:16 / 2:3 / 3:4) 多种比例选择。
3.  **UI 优化**：下拉菜单增加了分类标题和禁用项，结构更清晰。

## 配置文件持久化
更新时间：2025-12-03 13:48:00
更新类型：新增功能
更新内容：
1.  **配置自动保存与读取**：新增了配置持久化功能。软件启动时会自动读取 `config.json` 文件加载设置 (API Key、模型、分辨率、提示词)。
2.  **自动创建默认配置**：如果配置文件不存在，首次运行会自动生成包含默认值的 `config.json` 文件。
3.  **实时/退出保存**：在点击生成按钮以及关闭软件时，会自动将当前界面的配置信息保存到配置文件中，确保下次打开时恢复状态。

## 分辨率参数逻辑修复
更新时间：2025-12-03 13:35:00
更新类型：修复的bug
更新内容：
1.  **分辨率参数修正**：修正了 UI 版本向 API 发送分辨率参数的逻辑。之前分辨率参数被错误地包裹在 `parameters` 对象中，导致 API 忽略该参数并返回默认的竖屏图片。现在已修正为直接在根节点发送 `size` 参数 (且自动将 `*` 替换为 `x`)，确保能生成指定分辨率 (如 1024x1024, 1280x720 等) 的图片。

## 路径修复
更新时间：2025-12-03 13:27:00
更新类型：修复的bug
更新内容：
1.  **EXE 运行路径修复**：修复了打包成 EXE 后，图片保存路径错误指向临时文件夹的问题。现在会自动检测运行环境，确保生成的图片保存在 EXE 同级目录下的 `zimage` 文件夹中。
2.  **目录更名**：默认输出目录从 `out` 更改为 `zimage`。

## 问题修复与打包脚本
更新时间：2025-12-03 13:18:00
更新类型：修复的bug
更新内容：
1.  **修复双击报错**：修复了在图片上双击时出现的 `AttributeError: type object 'Qt' has no attribute 'MouseButtonDblClick'` 错误。正确使用了 `QEvent.MouseButtonDblClick`。
2.  **新增打包脚本**：创建了 `build_exe.bat` 脚本，支持一键将 Python 源码打包为独立的 `.exe` 可执行文件 (无需安装 Python 环境即可运行)。

## 详情窗口交互与视觉优化
更新时间：2025-12-03 13:05:00
更新类型：体验优化
更新内容：
1.  **高分屏 (High-DPI) 支持**：图片详情页现在会根据屏幕缩放比例自动调整图片渲染，确保在 150%/200% 缩放的显示器上也能以 1:1 的原始像素点对点显示，彻底解决图片模糊问题。
2.  **双击全屏**：在图片上双击左键即可快速切换全屏/窗口模式，交互更自然。
3.  **底部按钮视觉增强**：
    *   底部控制栏背景调整为深蓝色系 (`#2c3e50`)，与深色背景融为一体。
    *   按钮采用扁平化设计，悬停高亮，对比度更强，操作更清晰。
    *   "Close (关闭)" 按钮特别标注为红色，防止误触。

## 详情窗口升级：全屏与沉浸式浏览
更新时间：2025-12-03 12:52:00
更新类型：新增功能
更新内容：
1.  **全屏查看模式**：详情窗口新增 "Fullscreen (全屏)" 按钮，支持全屏沉浸式查看图片 (也可按 ESC 退出全屏)。
2.  **信息面板可折叠**：
    *   图片下方的详细信息 (提示词、模型等) 默认收起，最大化图片的展示空间。
    *   新增 "Show Info (显示信息)" 按钮，点击可展开查看详情。
3.  **视觉优化**：
    *   详情窗口背景调整为深色，提升看图体验。
    *   去除了窗口边距，全屏时图片真正铺满。

## 历史记录加载与元数据保存
更新时间：2025-12-03 12:35:00
更新类型：新增功能
更新内容：
1.  **历史记录加载**：软件启动时自动扫描 `out` 目录，加载历史生成的图片到画廊中。
2.  **元数据保存**：生成图片时同步保存同名的 `.json` 文件，记录提示词、模型、分辨率等信息。
3.  **画廊显示优化**：
    *   历史记录按时间倒序排列（最新的在最前面）。
    *   新生成的图片会自动插入到画廊的最上方，无需重启。
    *   加载历史记录时尽量使用文件路径而非直接加载图片到内存，优化启动速度。

## 优化交互体验与画廊显示
更新时间：2025-12-03 12:18:07
更新类型：性能优化
更新内容：
1.  **语言优先级调整**：所有界面文本调整为中文优先，英文作为辅助 (例如 "设置 (Settings)")。
2.  **输入体验优化**：
    *   修复了提示词输入框的黑色条纹样式问题，强制使用白色背景和黑色文字。
    *   增大了输入框高度，方便输入长文本。
3.  **现代化画廊布局 (Gallery Flow)**：
    *   实现了自定义的 `FlowLayout` 流式布局，生成的图片以网格形式自动排列，适应窗口大小。
    *   图片卡片统一为固定尺寸的缩略图，使用 `KeepAspectRatio` 模式，避免图片拉伸变形。
4.  **详情查看功能**：
    *   点击图片卡片可弹出 **详情窗口 (DetailDialog)**。
    *   详情窗口支持查看大图、完整提示词、模型参数和文件路径，并提供打开文件/目录的快捷操作。

## 优化 UI 界面与双语支持
更新时间：2025-12-03 12:08:49
更新类型：新增功能
更新内容：
1.  **界面中文化/双语化**：所有标签和按钮更新为中英双语，方便使用。
2.  **现代化 UI 设计**：
    *   采用左侧控制面板 + 右侧画廊的布局。
    *   应用了全新的 QSS 样式，包含圆角、阴影和悬停效果，界面更美观。
    *   使用了 `Fusion` 风格以增强跨平台一致性。
3.  **图片画廊功能**：
    *   新增右侧滚动区域，支持展示多张生成的历史图片。
    *   每张图片卡片包含缩略图、提示词摘要、文件名。
    *   提供 "打开文件" 和 "打开目录" 的快捷按钮。
4.  **文件保存优化**：
    *   生成的图片自动保存到 `out` 目录。
    *   文件名使用时间戳命名，避免覆盖。
5.  **隐私保护**：API Key 输入框增加显示/隐藏切换按钮。

## 新增 PySide6 图像生成 UI 应用
更新时间：2025-12-03 11:43:44
更新类型：新增功能
更新内容：
基于 qwen_image.py 的逻辑，创建了一个 PySide6 GUI 应用程序 (zimage_ui.py)。
主要功能包括：
1. 支持选择模型 (Qwen/Qwen-Image, Tongyi-MAI/Z-Image-Turbo)。
2. 支持设置分辨率 (1024*1024, 1280*720 等)。
3. 支持输入提示词生成图像。
4. 异步线程处理 API 请求，防止界面卡顿。
5. 界面直接显示生成的图像。
