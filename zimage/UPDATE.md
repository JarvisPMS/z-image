# 项目更新日志

## 聊天页面标识与头像更新
更新时间：2025-12-06 14:51:41
更新类型：新增功能
更新内容：
1. 将助手名称由“甲维斯AI”改为“甲维斯”。
2. 将助手头像替换为本地 `logo.png`。
3. 将右侧用户身份文案由“用户”改为“我”。

## 头部Logo替换与分辨率/聊天配置优化
更新时间：2025-12-06 11:13:30
更新类型：新增功能
更新内容：
1. 将首页头部图标替换为本地 `logo.png`，打包后资源正确引用。
2. Ratio 下拉依据当前清晰度组显示具体比值（如 `1:1`），与最新 `RESOLUTION_GROUPS` 数据同步。
3. 扩充图片生成模型列表，新增 7 款模型：真实幻想V2、麦橘超然、麦橘千问美人、麦橘写实、麦橘光影约拍、FLUX小红书极致真实V2、亚洲人像。
4. 统一聊天系统提示词为指定中文内容（简短回答，名称固定为甲维斯）。
5. 设置 Vite 构建资源基路径 `base: './'`，打包产物使用相对路径（已通过构建验证）。

# 项目更新日志

## 头部右上角按钮布局调整（语言切换置于最右）
更新时间：2025-12-06 14:30:27
更新类型：UI优化
更新内容：
1. 将语言切换按钮独立到最右侧分组，保证其位于头部最右端。
2. API Key 与“下载软件”按钮保持右侧中间分组，布局更清晰。

## 聊天改为流式，并支持最大token与中途取消
更新时间：2025-12-06 14:24:43
更新类型：新增功能
更新内容：
1. 新增流式聊天：后端以 SSE/Chunk 逐段返回，前端实时渲染。
2. 增加最大 token 限制（默认 1024，常量 `DEFAULT_MAX_CHAT_TOKENS` 可配置）。
3. 支持中途取消：请求使用 `AbortController`，点击“取消”立即中断连接，保留已生成内容。
4. 将聊天按钮文案从“提问”改为“发送”。

## 系统提示词恢复为用户指定版本
更新时间：2025-12-06 14:10:50
更新类型：修复bug
更新内容：
1. 将聊天系统提示词固定为：`回答要简短，不要长篇大论，直接给答案。你的设定是钢铁侠的助手甲维斯。`。
2. 后续不再随意覆盖该提示词，除非你再次明确提出修改需求。

## 为所有 index 页面添加站点图标
更新时间：2025-12-06 11:55:43
更新类型：新增功能
更新内容：
1. 在所有 index.html 中统一添加 `<link rel="icon" href="/favicon.ico" />`，确保浏览器标签页显示站点图标。
2. 涵盖页面：根目录、zimage、prompt、keyboard、bananacuter 的 `index.html`。

## 头部Logo无边框对齐优化
更新时间：2025-12-06 11:17:34
更新类型：新增功能
更新内容：
1. 移除图标容器的内边距与背景色，设置固定尺寸 `w-8 h-8` 并 `overflow-hidden`，使图片完全铺满容器、不再出现蓝色边框。
2. 图片采用 `object-cover` 填充方式，保证不同图片比例均能充满区域且保持圆角遮罩效果。

## 构建优化：静态资源改用相对路径
更新时间：2025-12-06 10:54:49
更新类型：修复bug
更新内容：
1. 通过设置 Vite `base: './'`，将打包后的 `index.html` 中 JS/CSS 由绝对路径 `/assets/...` 改为相对路径 `./assets/...`，便于相对目录部署。

## 新增“下载软件”按钮与弹窗
更新时间：2025-12-06 10:33:44
更新类型：新增功能
更新内容：
1. 在“更新 API Key”和语言切换按钮旁新增“下载软件”按钮。
2. 点击后弹出弹窗，包含“百度网盘”和“夸克网盘”的下载信息。
3. 下载链接从常量配置读取（`DOWNLOAD_LINKS`），可按需维护。

## 新增图片生成模型列表
更新时间：2025-12-06 10:28:16
更新类型：新增功能
更新内容：
1. 扩充图片模型选择：
   - 真实幻想V2（`KookYan/Kook_Qwen_zshx_v2`）
   - 麦橘超然（`MAILAND/majicflus_v1`）
   - 麦橘千问美人（`merjic/majicbeauty-qwen1`）
   - 麦橘写实（`MusePublic/majicMIX_realistic`）
   - 麦橘光影约拍（`WANGMOON/MAJICFLUS-photo`）
   - FLUX小红书极致真实V2（`yiwanji/FLUX_xiao_hong_shu_ji_zhi_zhen_shi_V2`）
   - 亚洲人像（`MusePublic/46_ckpt_SD_XL`）
2. 调用方式与既有模型一致，直接选择即生效。

## 分辨率数据更新：Standard/HD/Ultra 全量替换
更新时间：2025-12-06 09:57:40
更新类型：新增功能
更新内容：
1. 更新分辨率配置，保持页面选择逻辑不变，替换为新的三档分辨率：
   - Standard：1:1/3:4/4:3/16:9/9:16/3:2/2:3/21:9（以 512 起始）
   - HD：1:1/3:4/4:3/16:9/9:16/3:2/2:3/21:9（以 1024 起始）
   - Ultra：1:1/3:4/4:3/16:9/9:16/3:2/2:3/21:9（以 2048 起始）
2. Ratio 下拉改为显示具体比值（如 `1:1`），与各档位保持索引同步切换。

## 显示逻辑调整：429提示按需显示、聊天页仅显示聊天
更新时间：2025-12-06 09:44:51
更新类型：修复bug
更新内容：
1. 首页“API 限流（429）”提示默认不显示，仅当接口返回429错误时动态显示。
2. 切换至“聊天”Tab后，隐藏图片生成的结果区，聊天页只展示聊天内容。

## 聊天体验优化：回车发送与头像展示
更新时间：2025-12-05 16:31:16
更新类型：新增功能
更新内容：
1. 聊天输入框支持“Enter 发送、Shift+Enter 换行”。
2. 对话消息新增默认头像与身份标识：左侧“甲维斯AI”、右侧“用户”。
3. 长对话自动滚动到底部，始终看到最新消息。

## 聊天模块修复：模型切换与自动滚动
更新时间：2025-12-05 15:15:51
更新类型：修复bug
更新内容：
1. 聊天默认模型改为 `Qwen/Qwen3-235B-A22B-Instruct-2507`，并在标题处动态展示所选模型名称（如：`Qwen3-235B-A22B-Instruct-2507 对话`）。
2. 修复聊天模块“切换模型不生效”的显示问题，避免始终显示 `DeepSeek-V3.2 对话` 的误导。
3. 新增对话列表自动滚动到底部逻辑，长对话时可自动定位到最新消息。

## 聊天模型调整与系统提示词优化
更新时间：2025-12-05 15:03:28
更新类型：新增功能
更新内容：
1. 聊天模型列表移除 `GLM-4.6`，新增 `Qwen/Qwen3-235B-A22B-Instruct-2507`。
2. 为所有聊天模型统一注入系统提示词：`回答要简短，不要长篇大论，直接给答案。`。

## 首页提示追加配置教程链接
更新时间：2025-12-05 10:15:51
更新类型：新增功能
更新内容：
1. 在首页的“API 限流提醒”文案后追加外链“配置教程”，点击后以新标签页打开。
2. 链接地址：https://mp.weixin.qq.com/s/JW_eciEKlMCfyfnpt_LTIw

## 新增 DeepSeek-V3.2 文本对话支持
更新时间：2025-12-05 14:33:31
更新类型：新增功能
更新内容：
1. 增加独立的文本对话模块，调用 ModelScope 的 `/v1/chat/completions` 接口，默认模型为 `deepseek-ai/DeepSeek-V3.2`。
2. 引入 `services/chat.ts`，不影响既有图片生成逻辑与界面。
3. 页面改为 Tab 布局，默认显示图片生成；可切换到“聊天”Tab，支持多模型（含 `ZhipuAI/GLM-4.6`），并以对话形式呈现消息列表与输入框。

## 修复 GLM-4.6 聊天 400 错误
更新时间：2025-12-05 14:53:12
更新类型：修复bug
更新内容：
1. 在聊天请求体中自动注入 `system` 消息（默认：`You are a helpful assistant.`），确保与模型兼容的对话上下文结构。
2. 统一请求体为 OpenAI 兼容格式：`model` + `messages` + `stream`，提升跨模型的调用一致性。
3. 增强错误信息输出：当返回非 2xx 时，解析并展示详细错误字段（status/code/type/message/request_id 或原始文本）。

## 首页提示：API 限流提醒
更新时间：2025-12-05 09:34:16
更新类型：新增功能
更新内容：
1.  在首页头部下方添加醒目的提示信息，提醒用户“请设置自己的 ModelScope API Key”，以避免使用演示密钥触发 429 限流。
2.  文案支持中英双语，随页面语言自动切换。

## 添加 Google Analytics
更新时间：2025-12-03 18:15:00
更新类型：新增功能
更新内容：
1.  **集成 GA4**：
    *   在 `index.html` 中添加了 Google Analytics (G-C6G3S3X1YT) 的跟踪代码。
    *   用于统计网站访问量和用户行为。

## Vercel Serverless API 代理优化
更新时间：2025-12-03 18:10:00
更新类型：性能优化/代码重构
更新内容：
1.  **移除 `node-fetch` 依赖**：
    *   鉴于 Vercel Serverless Function (Node 18+) 已内置原生 `fetch` API，移除了冗余的 `node-fetch` 库。
    *   减少了项目依赖体积，简化了构建过程。
2.  **重构 `api/proxy.js`**：
    *   改用原生 `fetch` 进行请求转发。
    *   使用 `response.arrayBuffer()` 配合 `Buffer.from()` 处理二进制响应，替代了 `node-fetch` 特有的 `buffer()` 方法。
    *   保留了 Host 头清理逻辑，确保 SSL 握手正常。

## Vercel 部署修复
更新时间：2025-12-03 18:00:00
更新类型：修复bug/构建优化
更新内容：
1.  **新增构建脚本 `build-vercel.js`**：
    *   创建了自定义构建脚本，用于解决 Vite 构建不包含 Serverless Function 的问题。
    *   脚本流程：执行 `vite build` -> 复制 `api` 目录到 `dist/api` -> 复制 `vercel.json` 到 `dist/vercel.json`。
2.  **更新 package.json**：
    *   添加了 `build:vercel` 命令。
    *   现在可以通过 `npm run build:vercel` 生成包含前端资源和后端 API 的完整部署包。
3.  **解决 404 问题**：
    *   修复了部署后访问 `/api/proxy` 返回 404 的问题，确保 Serverless Function 在生产环境可用。

## Vercel Serverless API 代理
更新时间：2025-12-03 17:35:00
更新类型：修复bug/架构调整
更新内容：
1.  **优化本地开发支持**：
    *   将 `api/proxy/[...path].js` 重构为 `api/proxy.js`。
    *   在 `vercel.json` 中重新添加了 Rewrites 规则 (`/api/proxy/:path*` -> `/api/proxy?path=:path*`)。
    *   修复了 `vercel dev` 在本地 (Windows) 环境下可能无法正确路由 `[...path]` 文件导致的 404 错误。
2.  **增强代理逻辑**：
    *   `proxy.js` 现在能够更智能地解析目标路径，支持通过 `req.query.path` 或 `req.url` 获取。
    *   增加了详细的日志输出 (`Proxying request to: ...`)，方便调试。
    *   自动透传 URL 查询参数，确保 API 功能完整。

## Vercel 部署支持
更新时间：2025-12-03 16:50:00
更新类型：新增功能
更新内容：
1.  **添加 vercel.json**：
    *   创建了 `vercel.json` 配置文件，配置了 Rewrites 规则。
    *   解决了生产环境无法使用 `vite.config.ts` 中代理的问题，将 `/api-proxy/*` 正确转发至 `https://api-inference.modelscope.cn/*`。
    *   确保项目部署到 Vercel 后，跨域 API 请求也能正常工作。

## 安全性更新：移除硬编码密钥
更新时间：2025-12-03 16:40:00
更新类型：修复bug/安全性优化
更新内容：
1.  **创建 .env.local**：
    *   在 `zimage` 目录下创建了 `.env.local` 文件，用于存储敏感的 `VITE_MODELSCOPE_API_KEY`。
    *   该文件已被 Git 忽略 (`.gitignore` 中包含 `*.local`)，防止意外提交。
2.  **Web 端更新**：
    *   修改 `App.tsx`，优先尝试从 `import.meta.env.VITE_MODELSCOPE_API_KEY` 加载 API 密钥，作为本地开发的默认配置。
3.  **脚本与工具更新**：
    *   **Node.js**: 更新 `test_resolution.js`，添加了手动读取 `.env.local` 的逻辑，移除了硬编码的密钥。
    *   **Python**: 更新 `zimagepython` 目录下的 `zimage.py`, `zimage_ui.py`, `debug_zimage.py`, `qwen_image.py`，全部改为尝试读取 `../zimage/.env.local` 中的密钥。
    *   **Config**: 清除了 `zimagepython/config.json` 中的硬编码密钥。

## 添加使用步骤说明与底部版权更新
更新时间：2025-12-03 16:20:00
更新类型：新增功能
更新内容：
1.  **使用步骤说明**：
    *   在生成按钮下方添加了图文并茂的“使用步骤”指南。
    *   支持中英双语显示 (获取Key -> 输入提示词 -> 选择模型 -> 生成 -> 下载)。
    *   优化了步骤展示的 UI，使用数字徽章和简洁的文字引导用户。
2.  **底部版权更新**：
    *   更新了页脚 (Footer) 文本，添加了开发者署名 "Developed by Jarvis" / "由Jarvis开发"。
    *   保持了原有的 "Powered by ModelScope & Z-Image-Turbo" 鸣谢。

## 项目编译与样式构建修复
更新时间：2025-12-03 16:00:00
更新类型：修复bug/构建优化
更新内容：
1.  **引入 Tailwind CSS v4**：
    *   安装了 `@tailwindcss/postcss` 和 `tailwindcss`，替代了原先不稳定的 CDN 方案。
    *   配置了 `postcss.config.js` 和 `index.css` (使用 `@import "tailwindcss";`)。
    *   移除了 `index.html` 中的 CDN 引用，改为在 `index.tsx` 中引入本地构建的 CSS。
2.  **修复构建错误**：
    *   解决了 `vite build` 时因缺少 CSS 文件导致的警告。
    *   解决了 PostCSS 插件版本不兼容导致的构建失败问题 (升级为 v4 兼容配置)。
3.  **编译成功**：
    *   成功运行 `npm run build`，生成了优化后的 `dist` 目录，包含压缩的 JS 和 CSS 资源。

## 修复下拉菜单遮挡与API密钥多语言
更新时间：2025-12-03 15:40:00
更新类型：修复bug/新增功能
更新内容：
1.  **修复下拉菜单遮挡问题**：
    *   移除了 `App.tsx` 中主输入区域的 `overflow-hidden` 属性，解决了下拉菜单展开时被容器边缘截断的问题。
    *   重新调整了圆角 (Border Radius) 策略，确保输入框和选项栏在移除 `overflow-hidden` 后依然保持圆角外观。
2.  **API 密钥弹窗多语言支持**：
    *   在 `i18n.ts` 中添加了 API 密钥相关的翻译字段 (Update API Key, Get API Key, Save Key, Cancel 等)。
    *   更新 `ApiKeyInput` 组件，使其接收并显示动态翻译的标签，不再显示硬编码的英文。

## 下拉菜单UI深度美化
更新时间：2025-12-03 15:25:00
更新类型：UI优化
更新内容：
1.  **自定义下拉组件**：开发了 `CustomSelect` 组件，完全替代了原生的 HTML `<select>` 元素。
2.  **视觉升级**：
    *   下拉选项框 (Dropdown Popup) 现在拥有独立的悬浮层、阴影效果和圆角设计，不再是浏览器默认的“丑陋”样式。
    *   添加了选中项的高亮样式 (Indigo色块) 和对勾指示。
    *   添加了鼠标悬停时的背景色平滑过渡效果。
    *   添加了下拉时的动画效果 (Fade In + Slide Down)。
3.  **交互优化**：支持点击外部自动关闭下拉菜单。

## 修复模块导入路径错误
更新时间：2025-12-03 15:10:00
更新类型：修复bug
更新内容：
1.  **修复构建错误**：解决了 `App.tsx` 中找不到 `./i18n` 模块的引用错误。
2.  **文件结构调整**：将 `src/i18n.ts` 移动至项目根目录 `i18n.ts`，以匹配引用路径并简化项目结构。

## 多语言支持与21:9超宽屏
更新时间：2025-12-03 14:55:00
更新类型：新增功能
更新内容：
1.  **新增 21:9 超宽屏支持**：在 Standard, HD, Ultra HD 所有清晰度级别中，均添加了 Ultrawide (21:9) 比例选项。
2.  **多语言国际化 (i18n)**：
    *   支持中文 (Simplified Chinese) 和英文 (English) 切换。
    *   自动根据浏览器/系统语言设置默认语言。
    *   添加了顶部的语言切换按钮。
3.  **UI 美化**：优化了下拉菜单 (Select) 的样式，增加了鼠标悬停效果和阴影，使其与整体风格更协调。

## UI布局优化：紧凑型分辨率选择器
更新时间：2025-12-03 14:45:00
更新类型：新增功能/UI优化
更新内容：
1.  优化选项栏布局，将分辨率选择器移动至模型选择器右侧，形成紧凑的单行布局。
2.  将原有的展开式按钮组改为两个联动下拉菜单：
    *   **Quality (清晰度)**: 选择 SD/HD/Ultra HD。
    *   **Ratio (比例)**: 选择 Square/Portrait/Landscape。
3.  添加实时分辨率数值提示 (如 `1024x1024`)，方便用户确认最终尺寸。
4.  节省了垂直空间，提升了界面的整洁度。

## 分辨率分组选择功能
更新时间：2025-12-03 14:35:00
更新类型：新增功能
更新内容：
1.  重构 Web 界面，支持 Standard (SD), High Definition (HD), Ultra HD (2K/4K) 三种清晰度级别选择。
2.  每个清晰度级别下提供 Square, Portrait, Landscape 三种常用比例选项。
3.  更新 `constants.ts` 定义分辨率组数据结构。
4.  更新 `App.tsx` 适配新的分组选择 UI，修复了旧版 `ASPECT_RATIOS` 引用问题。

## 分辨率测试与验证
更新时间：2025-12-03 14:20:38
更新类型：性能优化
更新内容：
1.  创建并运行了 `test_resolution.js` 脚本，直接调用 ModelScope API 测试 `1024x1024` (1:1) 分辨率的生成能力。
2.  **测试结果**：脚本成功生成图片，但 PowerShell 验证脚本在解析图片尺寸时遇到语法错误。
3.  **人工验证**：虽然自动验证脚本失败，但从生成的 `test_result_1024x1024.jpg` 文件来看，API 确实返回了图片。如果 Web 端能正常显示不同比例，说明 API 本身是支持多分辨率的，可能是 Python 测试环境或参数传递存在差异。

## 模型选择功能与图片显示优化
更新时间：2025-12-03 14:08:13
更新类型：新增功能
更新内容：
1.  新增模型选择功能，支持 "Z-Image-Turbo (Fast)" 和 "Qwen-Image" 两种模型切换。
2.  更新 `constants.ts` 和 `App.tsx`，在 UI 中添加模型下拉选择框。
3.  优化大图显示逻辑：确保生成的图片始终按原始比例完整显示 (`object-contain`)，去除可能导致强制拉伸或裁剪的 CSS 样式。
4.  保留底部历史记录的方形预览图显示方式不变。

## 配置开发代理解决 CORS 问题
更新时间：2025-12-03 13:50:59
更新类型：修复bug
更新内容：
1.  修改 `vite.config.ts`，添加 `/api-proxy` 代理配置，将请求转发至 `https://api-inference.modelscope.cn`。
2.  更新 `constants.ts` 中的 `DEFAULT_API_ENDPOINT` 为 `/api-proxy/v1/images/generations`。
3.  解决浏览器环境因直接请求 ModelScope API 导致的跨域 (CORS) 错误 (`Failed to fetch`)。
4.  重启开发服务器以应用新的代理配置。

## API 调用逻辑重构
更新时间：2025-12-03 13:43:51
更新类型：修复bug
更新内容：
1.  重构 `services/api.ts` 中的 `generateImage` 函数。
2.  弃用原有的同步 OpenAI 兼容模式，改为与 Python 脚本一致的异步任务模式。
3.  在请求头中添加 `X-ModelScope-Async-Mode: true`。
4.  实现轮询机制 (Polling)，通过 `task_id` 定期检查任务状态，直到任务成功或失败。
5.  修复了 API 返回成功但无法获取图片 URL 的问题。

## 项目初始化与运行
更新时间：2025-12-03 13:40:50
更新类型：新增功能
更新内容：
1.  安装项目依赖 (npm install)。
2.  启动本地开发服务器 (npm run dev)。
3.  验证项目运行正常，Web 界面可访问 (http://localhost:3000)。
4.  确认项目功能为基于 ModelScope API 的图像生成工具 (Z-Image-Turbo)。
